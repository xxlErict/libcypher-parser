name: build-cypher-lint-windows

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-clang
            make
            git
            autoconf
            automake
            libtool
            pkg-config
            mingw-w64-x86_64-bison
            mingw-w64-x86_64-flex
            mingw-w64-x86_64-pkg-config
      - name: Show PATH
        run: bash -lc 'echo $PATH'

      - name: Build leg (PEG tool)
        run: bash -lc |
          set -e
          cd /tmp
          if [ ! -d peg ]; then
            git clone https://github.com/gpakosz/peg.git peg
          fi
          cd peg
          make || true
          # copy leg into /usr/bin if exists
          if [ -f leg ]; then
            cp leg /usr/bin/leg || true
            chmod +x /usr/bin/leg || true
          fi
          which leg || true

      - name: Clone libcypher-parser
        run: bash -lc |
          set -e
          if [ ! -d libcypher-parser ]; then
            git clone https://github.com/cleishm/libcypher-parser.git libcypher-parser
          fi
          cd libcypher-parser
          git rev-parse --abbrev-ref HEAD || true
          ls -la

      - name: Apply Windows compatibility fixes
        run: bash -lc |
          set -e
          cd libcypher-parser

          # 1) Ensure parser.c has setjmp typedef fallback for _WIN32
          if [ -f src/parser.c ]; then
            sed -i '1i #include <setjmp.h>\n#ifdef _WIN32\ntypedef jmp_buf sigjmp_buf;\n#define sigsetjmp(env, savesigs) setjmp(env)\n#define siglongjmp(env, val) longjmp(env, val)\n#endif\n' src/parser.c
          fi

          # 2) Fix cypher-lint.c: add Windows isatty/fileno mapping and include windows headers
          if [ -f src/cypher-lint.c ]; then
            sed -i '1i #ifdef _WIN32\n#include <io.h>\n#define isatty _isatty\n#define fileno _fileno\n#include <windows.h>\n#endif\n' src/cypher-lint.c

            # Replace 'functionName()' style no-arg prototypes with '(void)' for common functions.
            # This is a conservative replace for function declarations like "bool EnableVTMode()"
            # Note: this sed line is intentionally limited to handle typical patterns.
            sed -E -i 's/([[:space:];,{])([_a-zA-Z][_a-zA-Z0-9]*[[:space:]]*)\\(\\)/\\1\\2(void)/g' src/cypher-lint.c || true

            # Also ensure EnableVTMode definition uses (void)
            sed -E -i 's/bool[[:space:]]+EnableVTMode\\([[:space:]]*\\)/bool EnableVTMode(void)/g' src/cypher-lint.c || true
          fi

          # 3) Remove -Werror from generated Makefiles by adjusting env during configure (we'll pass CFLAGS)
          git status --porcelain || true

      - name: Generate configure and build
        run: bash -lc |
          set -e
          cd libcypher-parser

          # regenerate if needed
          ./autogen.sh || true

          # configure with relaxed warnings and disable heavy optimizations to speed up
          export CC=clang
          export CFLAGS="-O0 -Wno-error -Wno-strict-prototypes -Wno-implicit-function-declaration"
          ./configure --prefix=/usr || true

          # build single-threaded to avoid msys2 parallel issues
          make -j1 VERBOSE=1

      - name: Package artifact (ZIP)
        run: bash -lc |
          set -e
          cd libcypher-parser/src
          ls -la
          if [ -f cypher-lint.exe ]; then
            mkdir -p release
            cp cypher-lint.exe release/
            # include any needed runtime DLLs from mingw if present (best-effort)
            cp /mingw64/bin/libgcc* release/ 2>/dev/null || true
            cp /mingw64/bin/libwinpthread* release/ 2>/dev/null || true
            cd release
            zip -r cypher-lint-windows.zip *
            ls -la
          else
            echo "ERROR: cypher-lint.exe not found"
            exit 2
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cypher-lint-windows
          path: libcypher-parser/src/release/cypher-lint-windows.zip
