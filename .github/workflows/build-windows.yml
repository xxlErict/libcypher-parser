name: build-cypher-lint-windows

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSYS2 and toolchain
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >
            base-devel
            git
            make
            autoconf
            automake
            libtool
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-pkg-config

      - name: Build leg (PEG parser)
        shell: msys2 {0}
        run: |
          cd /tmp
          git clone https://github.com/gpakosz/peg.git || true
          cd peg
          make || true
          cp leg /usr/bin/leg
          chmod +x /usr/bin/leg
          which leg

      - name: Clone libcypher-parser
        shell: msys2 {0}
        run: |
          if [ ! -d libcypher-parser ]; then
            git clone https://github.com/cleishm/libcypher-parser.git
          fi

      - name: Patch cypher-lint.c (pre-build)
        shell: msys2 {0}
        run: |
          FILE=libcypher-parser/src/cypher-lint.c
          if [ -f "$FILE" ]; then
            sed -i '1i #ifdef _WIN32\n#include <io.h>\n#define isatty _isatty\n#define fileno _fileno\n#include <windows.h>\n#endif\n' "$FILE"
            sed -E -i 's/bool[[:space:]]+EnableVTMode[[:space:]]*\(\)/bool EnableVTMode(void)/g' "$FILE"
          fi

      - name: Autogen and configure
        shell: msys2 {0}
        run: |
          cd libcypher-parser
          ./autogen.sh
          export CC=clang
          export CFLAGS="-O0 -Wno-error -Wno-strict-prototypes -Wno-implicit-function-declaration"
          ./configure --prefix=/usr

      - name: Build libcypher-parser
        shell: msys2 {0}
        run: |
          cd libcypher-parser
          make -j1

      - name: Patch parser.c and parser_leg.c (post-build)
        shell: msys2 {0}
        run: |
          for FILE in libcypher-parser/src/parser.c libcypher-parser/src/parser_leg.c; do
            if [ -f "$FILE" ]; then
              sed -i '1i #ifdef _WIN32\n#include <setjmp.h>\ntypedef jmp_buf sigjmp_buf;\n#define sigsetjmp(env,savesigs) setjmp(env)\n#define siglongjmp(env,val) longjmp(env,val)\n#endif\n' "$FILE"
              echo "Patched $FILE"
            fi
          done

      - name: Package artifact
        shell: msys2 {0}
        run: |
          mkdir -p libcypher-parser/src/release
          cp libcypher-parser/src/cypher-lint.exe libcypher-parser/src/release/
          cp /mingw64/bin/libgcc* libcypher-parser/src/release/ 2>/dev/null || true
          cp /mingw64/bin/libwinpthread* libcypher-parser/src/release/ 2>/dev/null || true
          cd libcypher-parser/src/release
          zip -r cypher-lint-windows.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cypher-lint-windows
          path: libcypher-parser/src/release/cypher-lint-windows.zip
